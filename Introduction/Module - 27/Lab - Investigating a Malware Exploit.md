## Part 1: Use Kibana to Learn About a Malware Exploit
### Step 1: Narrow the timeframe.
a. Login to Security Onion with the analyst username and cyberops password.

b. Open Kibana (username analyst and password cyberops) and set an Absolute time range to narrow the
focus to log data from January 2017.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/d536b5c4-4290-4fbf-8798-4e5ad3f7130e)

c. You will see a graph appear with a single entry showing. To view more details, you need to narrow the
amount of time that is displayed. Narrow the time range in the Total Log Count Over Time visualization by clicking and dragging to select an area around the graph data point. You may need to repeat this process
until you see some detail in the graph.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/da11e06c-39f5-43ee-b56c-da8816a075ef)

### Step 2: Locate the Event in Kibana
a. After narrowing the time range in the main Kibana dashboard, go to the NIDS Alert Data dashboard by
clicking NIDS.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/e0819435-56c2-49af-8ad2-a446f6fd9f49)

b. Zoom in on the event by clicking and dragging in the NIDS – Alerts Over Time visualization further focus
in on the event timeframe. Since the event happened over a very short period of time, select just the
graph plot line. Zoom in until your display resembles the one below.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/3e8955ea-e6a9-4600-a048-26881dd3b3ef)

c. Click the first point on the timeline to filter for only that first event.

d. Now view details for the events that occurred at that time. Scroll all the way to the bottom of the
dashboard until you see the NIDS Alerts section of the page. The alerts are arranged by time. Expand
the first event in the list by clicking the pointer arrow that is to the left of the timestamp.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/e419f354-7896-4bb0-9bc4-ce42b44b3a31)

e. Look at the expanded alert details and answer the following questions:

What is the time of the first detected NIDS alert in Kibana?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/7933ac97-2725-46c2-9879-289c1c3f327d)

What is the source IP address in the alert?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/1f5332e1-5510-4df8-96d0-25814d5e36b3)

What is the destination IP address in the alert?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/6391309b-fd60-4723-bc49-ecd0a3ca6efc)

What is the destination port in the alert? What service is this?

- 80 : HTTP

What is the destination geo country name?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/87bf66a1-92f3-41dd-9f4c-9a88a66b6c28)

f. In a web browser on a computer that can connect to the internet, go to the link that is provided in the
signature_info field of the alert. This will take you to the Emerging Threats Snort alert rule for the exploit.
There are a series of rules shown. This is because signatures can change over time, or new and more
accurate rules are developed. The newest rule is at the top of the page. Examine details of the rule.

What is the malware family for this event?
- Exploit_Kit_RIG

What is the severity of the exploit?
- The signature severity is Major.

What is an Exploit Kit? (EK) Search on the internet to answer this question.
- An Exploit Kit is an exploit that uses multiple websites and redirects to infect a computer with malware.

### Step 3: View the Transcript capME!
a. Click the alert _id value, you can pivot to CapME to inspect the transcript of the event.

In the CapME! window you can see the transcript from the session. It shows the transactions between the
source computer, in blue, and the destinations that are accessed by the source. A lot of valuable
information, including a link to the pcap file that is related to this alert, is available in the transcript.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/7339ef6e-c8ae-4d35-a108-0098e795ac90)

Examine the first block of blue text. This is the request from the source to the destination webserver. Note
that two URLs are listed in this block. The first is tagged as SRC: REFERER. This is the website that the
source computer first accessed. However, the server referred browser the HTTP GET request to the
SRC:HOST. Something in the HTML sent the source to this site. It looks like this could be a drive-by
attack!

What website did the user intend to connect to?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/2818cc92-f7d3-4f5a-8083-80f24cfc9a9e)

What URL did the browser refer the user to?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/27fc6751-32f0-482a-a406-dc1800887a7d)

What kind of content is requested by the source host from tybenme.com? Why could this be a problem? Look in the DST server block of the transcript too.
- The content is shown as gzip. This could be a malware file that has been requested for download. It is probably a malware file. Because it is compressed, the contents of the file are obfuscated. It is not easy to see what is in the file.

b. Close the CapME! browser tab.

c. From the top of the NIDS Alert Dashboard click the HTTP entry located under Zeek Hunting

d. In the HTTP dashboard, verify that your absolute time range includes 2017-01-27 22:54:30.000 to 2017-01-27 22:56:00.000.


Scroll down to the HTTP – Sites section of the dashboard.

## Part 2: Investigate the Exploit with Sguil
### Step 1: Open Sguil and locate the alerts.
a. Launch Sguil from the desktop. Login with username analyst and password cyberops. Enable all
sensors and click Start.

b. Locate the group of alerts from January 27th 2017.

According to Sguil, what are the timestamps for the first and last of the alerts that occurred within about a
second of each other?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/83e8b105-97ea-4e60-b3f3-49f823b6b87e)

### Step 2: Investigate the alerts in Sguil.
a. Click the Show Packet Data and Show Rule checkboxes to see the packet header field information and
the IDS signature rule related to the alert.

b. Select the alert ID 5.2 (Event message ET CURRENT Evil Redirector Leading to EK Jul 12 2016).

According to the IDS signature rule which malware family triggered this alert? You may need to scroll
through the alert signature to find this entry.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/a5d0fe83-aba4-4725-bcd3-182e8aa20965)

c. Maximize the Sguil window and size the Event Message column so that you can see the text of the entire
message. Look at the Event Messages for each of the alert IDs related to this attack.

According to the Event Messages in Sguil what exploit kit (EK) is involved in this attack?
- RIG EK Exploit

Beyond labelling the attack as trojan activity, what other information is provided regarding the type and name of the malware involved?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/02d4aa20-1c92-4f0c-b735-62e82cea49d4)

By your best estimate looking at the alerts so far, what is the basic vector of this attack? How did the
attack take place?
- The attack seems to have taken place by visiting a malicious web page.

### Step 3: View Transcripts of Events
a. Right-click the associated alert ID 5.2 (Event Message ET CURRENT_EVENTS Evil Redirector Leading
to EK Jul 12 2016). Select Transcript from the menu as shown in the figure.

What are the referer and host websites that are involved in the first SRC event? What do you think the
user did to generate this alert?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/1d1fa524-2e51-492d-9909-7196eff8bed8)

b. Right-click the alert ID 5.24 (source IP address of 139.59.160.143 and Event Message ET
CURRENT_EVENTS Evil Redirector Leading to EK March 15 2017) and choose Transcript to open a
transcript of the conversation.

c. Refer to the transcript and answer the following questions:

What kind of request was involved?
- HTTP/1.1 GET request

Were any files requested?
- dle_js.js

What is the URL for the referer and the host website?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/f9ffda0d-c7e5-4163-a2f2-14bde696ea9d)

How the content encoded?
- gzip

d. Close the current transcript window. In the Sguil window, right-click the alert ID 5.25 (Event Message ET
CURRENT_EVENTS Rig EK URI Struct Mar 13 2017 M2) and open the transcript. According to the
information in the transcript answer the following questions:

How many requests and responses were involved in this alert?
- 3 requests and 3 responses

What was the first request?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/515d8237-a4aa-4a2d-8db0-428a39c81855)

Who was the referrer?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/f1ea746b-db93-4ab0-87f9-6c0da4f7889b)

Who was the host server request to?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/5702df33-9ec4-471b-a091-81730075f4bd)

Was the response encoded?
- Yes
What was the second request?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/cea16aff-575c-4a99-b56f-aa32001d5f30)

Who was the host server request to?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/5702df33-9ec4-471b-a091-81730075f4bd)

Was the response encoded?
- Yes

What was the third request?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/4ff094db-6fda-4405-afb7-29b113c15717)

Who was the referrer?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/3534e546-3a4a-48a7-9f7a-a2d2042fe4c9)

What was the Content-Type of the third response?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/631a0c08-83c3-4685-80d6-c19af90c21d1)

What were the first 3 characters of the data in the response? The data starts after the last DST: entry.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/aa847b01-8027-4f54-b655-9b4f52be7c34)

e. Close the transcript window.

f. Right-click the same ID again and choose Network Miner. Click the Files tab.

How many files are there and what is the file types?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/8dc85a92-b997-42db-80ed-81057e83e011)

## Part 3: Use Wireshark to Investigate an Attack

In Part 3, you will pivot to Wireshark to closely examine the details of the attack.
### Step 1: Pivot to Wireshark and Change Settings

a. In Sguil, right-click the alert ID 5.2 (Event Message ET CURRENT_EVENTS Evil Redirector Leading to
EK Jul 12 2016) and pivot to select Wireshark from the menu. The pcap that is associated with this alert
will open in Wireshark.

b. The default Wireshark setting uses a relative time per-packet which is not very helpful for isolating the
exact time an event occurred. To fix this, select to View > Time Display Format > Date and Time of Day
and then repeat a second time, View > Time Display Format > Seconds. Now your Wireshark Time
column has the date and timestamps. Resize the columns to make the display clearer if necessary.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/31ce7b34-0aea-4052-a3e6-ef3c044d4fde)

### Step 2: Investigate HTTP Traffic.

a. In Wireshark, use the http.request display filter to filter for web requests only.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/444d56fe-6d57-4d08-921d-7ee9a95902c9)

b. Select the first packet. In the packet details area, expand the Hypertext Transfer Protocol application
layer data.

What website directed the user to the www.homeimprovement.com website?
- Bing
![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/12e5bb26-5156-47a8-a4d2-f6aa13fdcc7e)

### Step 3: View HTTP Objects.

a. In Wireshark, choose File > Export Objects > HTTP.

b. In the Export HTTP objects list window, select the remodeling-your-kitchen-cabinets.html packet and save
it to your home folder.

c. Close Wireshark. In Sguil, right-click the alert ID 5.24 (source IP address 139.59.160.143 and Event
Message ET CURRRENT_EVENTS Evil Redirector Leading to EK March 15 2017) and choose
Wireshark to pivot to Wireshark. Apply an http.request display filter and answer the following questions:

What is the http request for?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/40250077-fa1a-438d-a03d-b5b6fcc32c52)

What is the host server?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/010c0808-d8fd-4dae-bef4-8830b3d44b70)

d. In Wireshark, go to File > Export Objects > HTTP and save the JavaScript file to your home folder.

e. Close Wireshark. In Sguil, right-click the alert ID 5.25 (Event Message ET CURRENT_EVENTS RIG EK
URI Struct Mar 13 2017 M2) and choose Wireshark to pivot to Wireshark. Apply an http.request display
filter. Notice that this alert corresponds to the three GET, POST, and GET requests that we looked at
earlier.

f. With the first packet selected, in the packet details area, expand the Hypertext Transfer Protocol
application layer data. Right-click the Host information and choose Apply as Column to add the Host
information to the packet list columns, as shown in the figure.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/6e581068-7627-47fc-8920-6c19e9a73262)

g. To make room for the Host column right-click the Length column header and uncheck it. This will remove
the Length column from the display.

h. The names of the servers are now clearly visible in the Host column of the packet list.

### Step 4: Create a Hash for an Exported Malware File.

a. In Wireshark, go to File > Export Objects > HTTP and save the two text/html files and the application/xshockwave-flash file to your home directory.

b. Now that you have saved the three files to your home folder, test to see if one of the files matches a known hash value for malware at virustotal.com. Issue a ls -l command to look at the files saved in your home directory. The flash file has the word SeaMonkey near the beginning of the long filename. The filename begins with %3fbiw=SeaMonkey. Use the ls -l command with grep to filter out the filename with the pattern seamonkey. The option -i ignores the case distinction.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/75cd8d9c-4fdd-45bc-8a2b-1047a21a3cba)

d. You can also generate a hash value by using NetworkMiner. Navigate to Sguil and right-click the alert ID
5.25 (Event Message ET CURRENT_EVENTS RIG EK URI Struct Mar 13 2017 M2) and select
NetworkMinor to pivot to NetworkMinor. Select the Files tab. In this example, right-click the file with swf
extension and select Calculate MD5 / SHA1 / SHA256 hash. Compare the SHA1 hash value with the
one from the previous step. The SHA1 hash values should be the same.

e. Open a web browser and go to virustotal.com. Click the Search tab and enter the hash value to search
for a match in the database of known malware hashes. VirusTotal will return a list of the virus detection
engines that have a rule that matches this hash. 

f. Investigate the Detection and Details tabs. Review the information that is provided on this hash value.

What did VirusTotal tell you about this file?

g. Close the browser and Wireshark. In Sguil, use alert ID 5.37 (Event Message ET CURRENT_EVENTS RIG EK Landing Sep 12 2016 T2) to pivot to Wireshark and examine the HTTP requests.

Are there any similarities to the earlier alerts?
- Yes, the alerts show GET, POST and GET requests to tyu.benme,com

Are the files similar? Do you see any differences?
- Yes, two text/html files and a flash file. The files names are different.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/c650416a-9bb4-4a29-91d4-b49e4a07791f)

h. Create a SHA-1 hash of the SWF file as you did previously.

Is this the same malware that was downloaded in the previous HTTP session?
- Yes. The two hashes match even though the filenames are different.
![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/0eabd9c4-7051-41e3-814f-acdcda0951a7)

i. In Sguil, the last 4 alerts in this series are related, and they also seem to be post-infection.

Why do they seem to be post-infection?
- All four alerts concern communication with the malware server.

What is interesting about first alert in the last 4 alerts in the series?
- Sends a UDP code to a ransomware checkin server

What type of communication is taking place in the second and third alerts in the series and what makes it
suspicious? 
- They are DNS requests that are initiated from the local host; however, it is unlikely that they are the result of normal user activity. They must be sent by the malware file. The .top domain does not look like a valid domain name.

j. Go to virustotal.com and do a URL search for the .top domain used in the attack.

What is the result?

k. Examine the last alert in the series in Wireshark. If it has any objects worth saving, export and save them
to your home folder.

What are the filenames if any?

## Part 4: Examine Exploit Artifacts
a. In Security Onion, open the remodeling-your-kitchen-cabinets.html file using your choice of text editor.
This webpage initiated the attack.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/dbdc4eab-e4da-43ac-847e-65f1f3906f34)

b. Open the dle_js.js file in choice of text editor and examine it.

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/7cd73598-2267-48d6-8ca0-44338f25b0c4)

What does the file do?
- Javascript document.write() will write content to the webpage, creating an iframe, that takes the user to a URI at tyu.benme.com

How does the code in the javascript file attempt to avoid detection? 
- By splitting the end iframe tag into two piecesThe </ifr’ +’ame>

c. In a text editor, open the text/html file that was saved to your home folder with Vivaldi as part of the
filename.
Examine the file and answer the following questions:

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/4937fcaa-f5b4-4ab3-8c0b-d9139a9f4bd1)

What kind of file it is?
- An HTML webpage

What are some interesting things about the iframe? Does it call anything?

![image](https://github.com/Akhilkj123/CyberOps/assets/65653010/e53a6be2-3542-4eea-b166-ccc22efb8383)

What does the start() function do?
- It writes to the browser window. It creates an HTML form and submits the variable NormalURL through POST. The NormalURL variable equals a URI at tyu.benme.com.

What do you think the purpose of the getBrowser() function is?
- The getBrowser() function determines the type of browser that the webpage is displayed in.

## Reflection
1. Exploit Kits are fairly complex exploits that use a variety of methods and resources to carry out an attack. Interestingly EKs may be used to deliver diverse malware payloads. This is because the EK developer may offer the exploit kit as a service to other threat actors. Therefore, RIG EK has been associated with a number of different malware payloads. The following questions may require you investigate the data further using the tools that were introduced in this lab.

2. It is useful to “tell the story” of an exploit to understand what happened and how it works. Start with the user
searching the internet with Bing. Search the web for more information on the RIG EK to help.
- While searching with Bing for information on home improvements, the user clicks on a link leading to www.homeimprovments.com, a website that has been compromised by a threat actor, resulting in the execution of a JavaScript that ultimately downloads a malicious Adobe Flash file, which, upon execution, retrieves and installs malware, subsequently establishing communication with a Command and Control (CnC) server.
